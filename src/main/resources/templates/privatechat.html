<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Private Chat</title>
    <style>
        * {
        box-sizing: border-box;
        }

        body, html {
            overflow-x: hidden;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 1rem;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
        }
        .back-btn {
            position: absolute;
            left: 1rem;
            font-size: 22px;
            color: #333;
            text-decoration: none;
        }
        .back-btn:hover {
            color: #007bff;
        }

        /* ðŸ‘‡ Receiver info (image + name) */
        .receiver-info {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            text-decoration: none;
        }
        .receiver-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #ddd;
        }
        .receiver-name {
            font-weight: bold;
            font-size: 18px;
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        .receiver-name:hover {
            color: #007bff;
        }

        #messages {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            flex-grow: 1;
            padding: 1rem;
        }
        .message {
            display: flex;
            justify-content: flex-start;
            max-width: 100%;
        }
        .message.me {
            justify-content: flex-end;
        }

        .bubble {
            display: flex;
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 18px;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
            flex-shrink: 1;
        }

        .message.me .bubble {
            background: #0084ff;
            color: white;
        }
        .message.other .bubble {
            background: #e4e6eb;
            color: black;
        }
        #msgForm {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #fff;
            border-top: 1px solid #ccc;
        }
        #text {
            flex: 1;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ccc;
            outline: none;
            font-size: 16px;
        }
        #emoji-btn, #sendBtn {
            margin-left: 8px;
            padding: 10px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }
        #emoji-btn {
            background: #eee;
            color: #555;
        }
        #sendBtn {
            background: #007bff;
            color: white;
        }
        #sendBtn:hover, #emoji-btn:hover {
            background: #0056b3;
            color: white;
        }
        emoji-picker {
            position: absolute;
            bottom: 60px;
            left: 20px;
            z-index: 1000;
            display: none;
        }
        .divider {
            text-align: center;
            margin: 4px 0;
            font-size: 12px;
            color: gray;
        }
        #messages .divider + .message { margin-top: 2px; }
        #messages .message + .divider { margin-top: 6px; }
    </style>
</head>
<body>

<div class="header">
    <a href="/users" class="back-btn">&#8592;</a>

    <!--  Receiver image + name -->
    <div class="receiver-info">
        <!-- <img th:src="@{'/uploads/profile/' + ${receiverImage}}" alt="User" class="receiver-img"/> -->
        <img th:src="@{${receiverImage != null and receiverImage != ''} 
                ? '/uploads/profile/' + ${receiverImage} 
                : '/images/default-profile.png'}" 
     alt="User" class="receiver-img"/>

        <a th:href="@{'/userinfo/' + ${receiver}}"
           class="receiver-name"
           th:text="${receiver}">
            Receiver
        </a>
    </div>
</div>

<div id="messages">
    <th:block th:each="m, iterStat : ${messages}">
        <th:block th:if="${iterStat.index == 0 
            or #temporals.format(messages[iterStat.index-1].timestamp, 'HH:mm') 
            != #temporals.format(m.timestamp, 'HH:mm')}">
            <div class="divider"
                 th:text="${#temporals.format(m.timestamp, 'HH:mm')}"></div>
        </th:block>

        <div th:classappend="${m.sender == sender} ? 'me' : 'other'" class="message">
            <div class="bubble">
                <span th:text="${m.content}"></span>
            </div>
        </div>
    </th:block>
</div>

<form id="msgForm">
    <button type="button" id="emoji-btn">ðŸ˜Š</button>
    <input type="text" id="text" placeholder="Type a message..." autocomplete="off"/>
    <button type="submit" id="sendBtn">&#9658;</button>
</form>

<emoji-picker id="emoji-picker"></emoji-picker>

<!-- WebSocket scripts -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<!-- Emoji picker -->
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

<script>
const messageInput = document.getElementById('text');
const emojiButton = document.getElementById('emoji-btn');
const emojiPicker = document.getElementById('emoji-picker');

// emoji picker toggle
customElements.whenDefined('emoji-picker').then(() => {
    emojiButton.addEventListener('click', (e) => {
        e.stopPropagation();
        emojiPicker.style.display =
            emojiPicker.style.display === 'none' || emojiPicker.style.display === ''
                ? 'block'
                : 'none';
    });

    emojiPicker.addEventListener('emoji-click', (event) => {
        const emoji = event.detail.unicode;
        const start = messageInput.selectionStart;
        const end = messageInput.selectionEnd;
        messageInput.value =
            messageInput.value.slice(0, start) + emoji + messageInput.value.slice(end);
        messageInput.selectionStart = messageInput.selectionEnd = start + emoji.length;
        messageInput.focus();
    });

    document.addEventListener('click', (e) => {
        if (!emojiPicker.contains(e.target) && e.target !== emojiButton) {
            emojiPicker.style.display = 'none';
        }
    });
});
</script>

<!-- WebSocket logic -->
<script th:inline="javascript">
    let receiver = /*[[${receiver}]]*/ "";
    let sender = /*[[${sender}]]*/ "";
    let stompClient;
    let lastTimeShown = "";

    function connect() {
        const socket = new SockJS('/ws-chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, (frame) => {
            console.log("Connected: " + frame);
            stompClient.subscribe('/user/queue/messages', (msg) => {
                const data = JSON.parse(msg.body);
                showMessage(data.from, data.text);
            });
        }, (error) => {
            console.error("WebSocket error: ", error);
            setTimeout(connect, 5000);
        });
    }
    connect();

    function showMessage(from, text) {
        const now = new Date();
        const timeString = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

        if (timeString !== lastTimeShown) {
            lastTimeShown = timeString;
            const divider = document.createElement("div");
            divider.classList.add("divider");
            divider.textContent = timeString;
            document.getElementById("messages").appendChild(divider);
        }

        const el = document.createElement("div");
        el.classList.add("message");
        el.classList.add(from === sender ? "me" : "other");

        el.innerHTML = `<div class="bubble"><span>${text}</span></div>`;
        document.getElementById("messages").appendChild(el);
        el.scrollIntoView({behavior:"smooth", block:"end"});
    }

    document.getElementById('msgForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (!text) return;

        stompClient.send("/app/chat.private", {}, JSON.stringify({
            to: receiver,
            text: text
        }));

        showMessage(sender, text);
        messageInput.value = '';
        messageInput.focus();
    });

    window.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        const messages = document.getElementById("messages");
        messages.scrollTop = messages.scrollHeight;
    }, 100); // Delay ensures DOM and images are fully loaded
});

</script>

</body>
</html>
